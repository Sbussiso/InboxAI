
{% extends "base.html" %}

{% block content %}


<head>
        <!-- Bootstrap JavaScript -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">

    <!--google fonts-->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>


<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" style="display: none;">
        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden"></span>
            </div>
        </div>
    </div>

    <!--for flexbox-->
    <div id="mainBox" class="d-flex flex-column align-items-center justify-content-center vh-100 pt-5">
        
        <div id="boxes-container" class="container-fluid bg-white border rounded overflow-auto">

            <div id="chatbox" class="container-fluid">
                <p class="botText header-text text-center h2 pt-3" header-text ><span>lets go through some emails!</span></p>
                
                <!-- displays one email at a time-->
                <div class="border rounded p-3">
                    <div id="senderInfo" class="border rounded bg-grey p-3 header-text h5">
                        <p id="senderId"><strong>Sender:</strong></p>
                        <p id="requestSize"><strong>Request size:</strong></p>
                        <p id="subject"><strong>Subject:</strong></p>
                    </div>
                        <p id="gpt3" class="mt-5 p-3 bg-grey border rounded "><strong>AI:</strong></p>
                    
                </div>
            
            <!-- button commands -->
            
            <div id="button-commands" class="container-fluid pt-5 mb-2">
                <button id="prevButton" class="btn btn-primary">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
            
                <button id="nextButton" class="btn btn-primary">
                    <i class="fas fa-arrow-right"></i> Next
                </button>
            
                <button id="starButton" class="btn btn-warning">
                    <i class="fas fa-star"></i> Star
                </button>
            
                <button id="deleteButton" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            
                <button id="regenerateButton" class="btn btn-danger">
                    <i class="fas fa-sync-alt"></i> Regenerate Summary
                </button>
            
                <button id="draftButton" class="btn btn-primary">
                    <i class="fas fa-pencil-alt"></i> Draft Response
                </button>
            
                <button id="openButton" class="btn btn-primary">
                    <i class="fas fa-envelope-open-text"></i> Open Gmail
                </button>
            
                <!-- Trigger button for assistant modal -->
                <button type="button" id="assistantButton" class="btn btn-primary" data-toggle="modal" data-target="#assistantModal">
                    <i class="fas fa-user-secret"></i> Assistant
                </button>

            </div>
            

            <!-- draft response box display-->
        
            <div id="draftbox" class="container-fluid">
                <h2>Draft Or Generate Response Here</h2>
                <textarea id="responseDraft" class="form-control" rows="10"></textarea>
            
                <div class="row pt-3">
                    <div class="col">
                        <button id="generateDraft" class="btn btn-primary btn-block">
                            <i class="fas fa-magic"></i> Generate Draft
                        </button>
                    </div>
                    <div class="col">
                        <label for="attachmentButton" class="btn btn-primary btn-block">
                            <i class="fas fa-paperclip"></i> Attachment
                        </label>
                        <input id="attachmentButton" type="file" style="display: none;">
                    </div>
                    <div class="col">
                        <button id="draftSubmit" class="btn btn-danger btn-block">
                            <i class="fas fa-paper-plane"></i> Send Response
                        </button>
                    </div>
                    <div class="col">
                        <button id="backButton" class="btn btn-primary btn-block">
                            <i class="fas fa-arrow-left"></i> Close
                        </button>
                    </div>
                </div>
            </div>
            
            
            

            <!-- Assistant Modal -->
            <div class="modal fade" id="assistantModal" tabindex="-1" role="dialog" aria-labelledby="assistantModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-right" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="assistantModalLabel">Assistant Chat</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body d-flex flex-column" style="height: 80vh;"> <!-- This sets the height of the modal body -->
                            <div id="inboxChatbox" class="flex-grow-1 overflow-auto mb-3">
                                <!-- Chat messages will be here -->
                            </div>
                            <div class="mt-auto">
                                <textarea id="inboxTextInput" name="msg" placeholder="Message" class="form-control"></textarea>
                                <button id="inboxButtonInput" type="button" class="btn btn-primary btn-block mt-2">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
        </div>
    </div>

    <!--warning for sending emails-->
    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmationModalLabel">Confirm Send</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to send this response? If you used AI generation you need to review the response before sending.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmSendButton">Confirm Send</button>
                </div>
            </div>
        </div>
    </div>

    <!--warning for deleting emails-->
    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirm Deletion</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
            Deleting this email removes it from both the database and Gmail
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
        </div>
    </div>
  

</body>


<!-- custom CSS styling -->
<style>
    .modal-dialog-right {
        position: fixed;
        margin: auto;
        width: 100%;
        height: 100%;
        right: 0;
    }
    .modal-content {
        height: 100%;
        overflow: auto;
    }

    .bg-grey {
    background-color: #f8f9fa !important;
}

    body {
        font-family: 'Roboto', sans-serif;
    }

    .header-text {
    font-family: 'Fredoka One', sans-serif;
    }


    h1, h2, h3 {
        font-family: 'Roboto', sans-serif;
        font-weight: 700; /* for bold headings */
    }

    #loadingSpinner {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100px;
    height: 100px;
    z-index: 1050;
}

    #loadingSpinner .spinner-border {
        width: 100%;
        height: 100%;
        border-width: 10px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Overlay */
    .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1050;
}

    .spinner-container {
        width: 100px;
        height: 100px;
    }

    .spinner-border {
        width: 100%;
        height: 100%;
        border-width: 10px;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }



    

</style>
<!--end of CSS styling-->


<!--beginning of javascript-->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<script>
    $(document).ready(function() {
        
        var summaries = {{ summaries|tojson }};
        var currentSummaryIndex = 0;

        // Function to show and hide spinner
        function showSpinner() {
            $('.loading-overlay').show();
            $('#loadingSpinner').show();
        }
        function hideSpinner() {
            $('.loading-overlay').hide();
            $('#loadingSpinner').hide();
        }
       
        hideSpinner();

        function displaySummary(index) {
            // Display summary logic here... potentially uneccessary delete late

            if (index >= summaries.length || index < 0) {
                console.error("Invalid index: ", index);
                return;
            }

            var summary = summaries[index];
            if (!summary) {
                console.error("No summary found at index: ", index);
                return;
            }

           //displays email data
            $('#senderId').text("Sender: " + summary['sender']);
            $('#requestSize').text("Request size: " + summary['token_size']);
            $('#subject').text("Subject: " + summary['subject']);
            $('#gpt3').text('AI: ' + summary['gpt_response']);
            console.log("displaySummary called with index", index);
            console.log("summary", summary);
        }


        


        $('#nextButton').click(function() {
          // Increment the currentSummaryIndex if not at the end
          if (currentSummaryIndex < summaries.length - 1) {
            currentSummaryIndex++;
            displaySummary(currentSummaryIndex);
          }
          else {
            console.log("reached end of summaries.");
          }
        });

        $('#prevButton').click(function() {
            //decrement the currentSummaryIndex if not at beginning
            if (currentSummaryIndex > 0) {
                currentSummaryIndex--;
                displaySummary(currentSummaryIndex);
            }
            else {
                console.log("no previous summaries");
            }
        });

        // For user deleting emails - Only shows the modal
        $('#deleteButton').click(function() {
            // Show the delete confirmation modal
            $('#deleteConfirmationModal').modal('show');
        });

        // For user confirming deletion
        $('#confirmDeleteButton').click(function() {
            // Here, implement the AJAX call to actually delete the email
            var currentEmailId = summaries[currentSummaryIndex]['id'];
            showSpinner();
            console.log("Confirmed deletion button press for Email ID: ", currentEmailId);

            $.ajax({
                url: '/delete_email',
                type: 'POST',
                data: JSON.stringify({ 'email_id': currentEmailId }),
                contentType: 'application/json',
                success: function(result) {
                    console.log("Email deleted successfully");

                    // Remove email from summaries array
                    summaries.splice(currentSummaryIndex, 1);

                    // Adjust index and show next/previous email
                    if (currentSummaryIndex >= summaries.length) {
                        currentSummaryIndex--;
                    }
                    if (summaries.length > 0) {
                        displaySummary(currentSummaryIndex);
                    } else {
                        // Handle case where no emails are left
                        $('#senderId').text("No emails available.");
                        $('#requestSize').text("");
                        $('#subject').text("");
                        $('#gpt3').text("");
                    }
                },
                error: function(error) {
                    console.log("Error in deleting email: ", error);
                },
                complete: function() {
                    hideSpinner();
                }
            });

            // Close the modal
            $('#deleteConfirmationModal').modal('hide');
        });

      



        $('#starButton').click(function() {
            var currentEmailId = summaries[currentSummaryIndex]['id'];
            console.log("Current Email ID: ", currentEmailId);
            $.ajax({
                url: '/star_email',
                type: 'POST',
                data: JSON.stringify({ 'email_id': currentEmailId}),
                contentType: 'application/json'
                
            });
        });

        //regenerates and displays response
        $('#regenerateButton').click(function() {
            var currentEmailId = summaries[currentSummaryIndex]['id'];
            showSpinner();
            console.log("Current Email ID: ", currentEmailId);
            $.ajax({
                url: '/regenerate_response',
                type: 'POST',
                data: JSON.stringify({ 'email_id': currentEmailId}),
                contentType: 'application/json',
                success: function(response) {
                    console.log("Response: ", response);
                    // Update the local summary's gpt_response
                    summaries[currentSummaryIndex]['gpt_response'] = response.gpt_response;
                    // Update the displayed summary
                    displaySummary(currentSummaryIndex);

                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log("Error: ", textStatus, ", ", errorThrown);
                },
                complete: function() {
                    hideSpinner();
                }       

            });
            
        });

        //open button functionality
        $('#openButton').click(function(){
            console.log("redirecting to gmail.com .......");
            window.location = "https://www.gmail.com";
        });

        //draft button functionality
        $('#draftbox').hide();
        $('#draftButton').click(function(){
            $('#draftbox').show();
            $('#prevButton').hide();
            $('#nextButton').hide();
            
        });



        //email attachment button functionality
        $('#attachmentButton').click(function() {
            var file = $('#attachmentButton')[0].files[0]; // Get the file from the input
            if (file) { // if a file was selected
                console.log('file is found');
                if (file.size > 0) { // check if the file is not empty
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var contents = e.target.result;
                        $.ajax({
                            url: '/draft_response_attachment',
                            type: 'POST',
                            data: JSON.stringify({ 'file_contents':contents }),
                            contentType: 'application/json',
                            success: function(response) {
                                console.log("Success: ", response);
                            },
                            error: function(jqXHR, textStatus, errorThrown){
                                console.log("Error: ", textStatus, ", ", errorThrown);
                            }
                        });
                        // Do something with the file contents here
                        // You will typically need to send the file contents to your server
                        // and attach it to the email from there
                    };
                    reader.readAsDataURL(file); // Read the file as a Data URL
                } else {
                    console.log('File is empty');
                }
            } else {
                console.log('No file selected');
            }
        });





        // draft box submit button
        $('#draftSubmit').click(function(){
           // Store data in temporary variables
            window.tempEmailData = {
                emailId: summaries[currentSummaryIndex]['id'],
                draftResponse: $('#responseDraft').val(),
                file: $('#attachmentButton')[0].files[0]
        };

        // When the 'Send Response' button is clicked
        $('#draftSubmit').click(function() {
            // Retrieve data to be sent
            var currentEmailId = summaries[currentSummaryIndex]['id'];
            var draftResponse = $('#responseDraft').val();
            var file = $('#attachmentButton')[0].files[0];

            // Show the confirmation modal
            $('#confirmationModal').modal('show');

            // Store the data temporarily for use in the confirm send button handler
            window.tempEmailData = {
                emailId: currentEmailId,
                draftResponse: draftResponse,
                file: file
            };
        });

        // Confirm Send button inside the modal
        $('#confirmSendButton').click(function() {
            // Retrieve stored data
            var currentEmailId = window.tempEmailData.emailId;
            var draftResponse = window.tempEmailData.draftResponse;
            var file = window.tempEmailData.file;

            // AJAX request to send email (without attachment logic for simplicity)
            showSpinner();
            $.ajax({
                url: '/draft_response',
                type: 'POST',
                data: JSON.stringify({ 'email_id': currentEmailId, 'draft_response': draftResponse }),
                contentType: 'application/json',
                success: function(response) {
                    console.log("Email sent successfully");
                    // Additional success logic
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Error in sending email: ", textStatus, errorThrown);
                    // Error handling logic
                },
                complete: function() {
                    hideSpinner();
                }
            });

            // Clear temporary data and close the modal
            delete window.tempEmailData;
            $('#confirmationModal').modal('hide');
        });



    // Show the confirmation modal
    $('#confirmationModal').modal('show');
        });

        // This function will get called when the user clicks the 'Send' button
        function getInboxBotResponse() {
            var rawText = $("#inboxTextInput").val();  // Get user's input
            console.log("User input:", rawText);  
            var userHtml = '<p class="userText"><span>' + rawText + '</span></p>';
            $("#inboxTextInput").val("");  // Clear the input box
            $("#inboxChatbox").append(userHtml);  // Add user's message to chat

            // AJAX request to the server
            jQuery.ajax({
                url: '/get',  // Server script to process the input
                type: 'GET',
                data: { msg: rawText },
                success: function(data) {  // If request was successful
                    console.log("API response data:", data);  
                    var botHtml = '<p class="botText"><span>' + data.message + '</span></p>';
                    $("#inboxChatbox").append(botHtml);  // Add bot's response to chat
                    
                },
                error: function() {
                    alert("Error occurred.");  // Show an alert box if there was an error
                }
            });
        }

        // Add event listener for when the user clicks the 'Send' button
        $("#inboxButtonInput").click(function() {
            getInboxBotResponse();
        });



        // back button functionality
        $('#backButton').click(function(){
            // Clear the textarea and hide the draftbox
            $('#responseDraft').val('');
            $('#draftbox').hide();
            $('#prevButton').show();
            $('#nextButton').show();
        });

        // generates a gpt 3 auto response to email
        $('#generateDraft').click(function(){
            var currentEmailId = summaries[currentSummaryIndex]['id'];
            console.log("Current Email ID: ", currentEmailId);
            showSpinner();
            $.ajax({
                url: '/generate_draft',
                type: 'POST',
                data: JSON.stringify({ 'email_id': currentEmailId }),
                contentType: 'application/json',
                success: function(response) {
                    console.log("Success: ", response);
                    // Set the value of the draft response text box
                    $('#responseDraft').val(response.gpt3_response);
                },
                error: function(jqXHR, textStatus, errorThrown){
                    console.log("Error: ", textStatus, ", ", errorThrown);
                },
                complete: function() {
                    hideSpinner();
                }
            });
        });






        function updateChatbox() {
            $.ajax({
                url: '/inboxAI',
                success: function(result) {
                    // Parse JSON and update summaries variable
                    summaries = result;
                    console.log(summaries);
                    console.log(result);

                    // Reset current summary index to 0
                    currentSummaryIndex = 0;

                    // Update display
                    displaySummary(currentSummaryIndex);
                    console.log(displaySummary(currentSummaryIndex));
                },
                error: function(error){
                    console.log("Error: ", error);
                }
            });
        };

        updateChatbox(); // Call the updateChatbox function to fetch initial data

        // Set up button handlers and other logic...

    });
</script>
<!--end of javascript-->


{% endblock %}








